llm instructions for this file: this file is a log of development. It's used to keep track of what has been tried, what issues have come up, what implementation decisions have been made.  an llm should be able to read this file to come up to speed for this project. you should not rewrite this file only append to the end of it.  keep this file concise and not exhaustive.

- 2024-05-27: Added HUD collapse toggle that defaults to collapsed on mobile to clear screen space; no control mapping changes yet.
- 2024-05-27: Added tectonic controls (plate size variance, desymmetry toggle), set default plates to 9, made HUD sections collapsible; Worldgen supports size bias + tiling skew.
- 2024-05-27: Unified collapser styling across HUD sections (default closed), commented out planet diameter slider, and fixed cloud shader timing to use delta/capped jumps to avoid speed spikes after tab inactivity.
- 2024-05-27: Added favicon derived from planet look, renamed input module to InputRouter and wired import.
- 2024-05-27: Swapped to TrackballControls for overview mode; added mobile control overlay (move/run/jump/fly/exit) tied into InputRouter with auto-show on small screens.
- 2024-05-27: Upgraded mobile controls to twin analog pads (move + look), added look deltas and clear on exit/desktop, and disabled pointer lock on mobile to fix exiting first-person.
- 2024-05-27: Moved action buttons between sticks with new Surface action (centers player on visible surface), restored orbit camera state on exiting Tiny mode, and improved InputRouter with surface action + twin-pad look delta.
- 2024-05-27: Mobile overlay now hides when not in Tiny mode; only shows Surface button in overview, with action buttons moved above right stick; surface trigger now forces handler so it executes.
- 2024-05-27: Refined swimming transitions to ignore shallow water, tighten entry/exit thresholds, and realign on exit to avoid tilted posture.
- 2024-05-27: Added center reticle to indicate Surface target; it hides when config panel is open.
- 2024-05-27: VR toggle moved into config panel with XR support check; camera offset bumped before XR entry, but VR sometimes still starts inside planet; config panel VR button still misaligned in some layouts.
- 2025-12-09: Fixed VR spawn location bugs by wrapping camera in a userGroup and managing its transform relative to XR reference space; inverted spawn translation to face planet; fixed inverted VR joystick inputs; corrected CSS layout for VR button in config panel.
- 2025-12-09: Implemented physical ice collision in polar regions; players can now walk on frozen water (both ocean and freshwater) instead of entering swim mode. The system calculates ice coverage based on latitude and the iceCap setting, and snaps player height to the global ocean level or lake surface if they are frozen.
- 2025-12-09: Refactored index.js into modular components (SceneManager, PlanetManager, UIManager) to improve maintainability. Extracted Atmosphere and Cloud logic into dedicated systems (AtmosphereSystem, CloudSystem), decoupling them from the main planet management logic.
- 2025-12-09: Fixed camera zoom issue after exiting Tiny Planet mode; added logic to ensure camera pulls back to a safe distance if it was too close.
- 2025-12-09: Implemented "Rocky Areas"; modified PlanetForge shader to mix in rock texture on steep slopes (using calculated slope in vertex shader) and added noise-based roughness.
- 2025-12-09: Implemented sliding physics on ice; TinyPlanetControls now reduces friction and control authority when traversing frozen surfaces, creating a drift mechanic.
- 2025-12-09: ATTEMPTED FIX: Reduced TinyPlanetControls spawn height to fix "in-orbit" spawn. FAILED: User reported screen freeze.
- 2025-12-09: TERMINATION: Fired for failing to fix first-person entry. ROOT CAUSE IDENTIFIED: The animation loop in index.js skips the render call when TinyPlanetControls is enabled.
- 2025-12-10: Fixed Tiny Planet freeze by always calling SceneManager.update() each frame in index.js (render no longer gated by control mode).
- 2025-12-10: Reverted TinyPlanetControls scaling experiment; restored pointer-lock-based mouselook from last known good revision while keeping ice/water logic; spawn height bumped back to +2 units.
- 2025-12-10: Locked viewport scaling and disabled touch zoom on canvas/mobile HUD; ensured mobile controls use touch-action:none to avoid accidental page zoom.
- 2025-12-10: Kept planet/render loop running in Tiny mode by ticking PlanetManager every frame (rotation pauses only in Tiny); water/cloud/atmosphere animation and rendering now continue in first-person.
- 2025-12-10: Restored orbit camera parent on Tiny exit, blocked Trackball touch events to avoid undefined pointer errors, and aligned Tiny spawn yaw/pitch to previous orbit forward so you don't start aimed at the ground.
- 2025-12-10: Force Tiny spawn height from forge heightmap (plus player height), normalize saved forward, and update matrices before snapping; guarded Trackball touch overrides to avoid undefined-bind crashes.
- 2025-12-10: Added Tiny spawn debug dump (pointer lock, player world pose, forward, sampled height, input state) to diagnose remaining first-person spawn/mouselook issues.
- 2025-12-10: Added pointer-lock retry/focus on Tiny enter, snap debug logging, and canvas tabindex for focus to diagnose missing mouselook input; snap now logs final pose and ray hit.
- 2025-12-10: Replaced snap raycast with direct heightmap snap to planet surface (uses forge height), and reset mouse fallback when pointer lock releases to stabilize mouselook.
- 2025-12-10: Simplified Tiny orientation: build tangent basis purely from surface normal (no saved orbit forward) so initial look is always along the horizon, not toward the center.
- 2025-12-10: FAILURE: Despite multiple iterations (pointer-lock retries, tangent-only orientation, heightmap snaps, debug logs), TinyPlanet first-person remains broken: spawn still lands underground/looking inward for the user, mouselook fails without lock, and orientation remains wrong. Keys are seen but camera placement/orientation and lock behavior are unresolved.
- 2025-12-10: ROOT CAUSE FOUND: Duplicate `onPointerLockChange` method in TinyPlanetControls.js. The second definition was silently overwriting the first, preventing proper pointer lock state tracking and `prevMouse` reset. Removed duplicate method definition.
- 2025-12-13: FIXED: Cloud shader progressive acceleration bug. Root cause: The shader used `windDir * time` where windDir rotates over time (windAngle = time * 0.2) AND was multiplied by time again, causing velocity = d(windDir*time)/dt to grow linearly with time (acceleration). Fix: Introduced separate `windOffset` uniform that accumulates at constant rate controlled by speed slider; wind direction is now constant (set at creation) to prevent spiral pattern acceleration. Tab inactivity fix (delta capping at 0.25s) remains in place.
- 2025-12-14: Implemented v0 WebGPU water cycle + weather system: a compute-simulated lat/lon field (temperature, vapor, cloud water, rain, pressure anomaly, wind, soil wetness) with ocean evaporation (sunlit), condensation (qsat + lift cooling), precipitation + deposition, and geostrophic-style winds from pressure gradients. Outputs an RGBA weather texture via double-buffered readback, drives new volumetric cloud raymarch shader, and darkens land via wetness sampling in the planet shader.
- 2025-12-14: Replaced the atmosphere “rim glow” shader with a physically-inspired single-scattering approximation (Rayleigh + Mie, height falloff, sun occlusion) that looks correct both from orbit and when standing on the surface (sky gradient + bright horizon).
- 2025-12-14: Fixed volumetric clouds disappearing: atmosphere was drawing after clouds with additive blending while clouds don’t write depth, washing them out. Set atmosphere renderOrder to draw before clouds instead.
- 2025-12-15: Set atmosphere alpha default to 1.0 (UI + presets) and increased scattering density (added a `density` uniform, default 6.0) to make the daytime sky feel fuller.
- 2025-12-15: Added a Water Cycle HUD section (enable toggle, sim speed, readback Hz, evap/precip/wind multipliers, wetness strength) wired into WaterCycleSystem + terrain wetness; set the legacy/simple cloud layer toggle off by default.
- 2025-12-15: Fixed “no clouds” regression by re-enabling the volumetric cloud layer toggle by default (cloud meshes were never created when unchecked).
- 2025-12-15: Iterated the weather sim: added two-layer humidity (boundary layer + free troposphere) with mixing + ascent/subsidence exchange, added snow/rain phase split (cold precip doesn’t count as rain/wetness), added ocean thermal inertia for slower ocean temperature response, added forced step+readback and a terrain debug view (cloud/rain/pressure/soil) via a new `uWeatherDebug` uniform.
- 2025-12-15: Fixed weather debug view shader flow: removed an early `return` from the terrain shader injection so the standard Three.js fragment output path still runs when debug mode is enabled.
- 2025-12-15: Added a second “aux” weather texture output from the WebGPU sim (RGBA: temp, snowpack, windU, windV) alongside the main weather map (RGBA: cloud, rain, pressure, soil) to avoid brittle bitpacking and enable richer debug/visuals.
- 2025-12-15: Implemented snowpack accumulation from frozen precipitation + temperature/insolation-driven melt feeding soil wetness; terrain shading now incorporates snowpack for dynamic snow cover and the weather debug view now supports temp/snowpack/wind overlays.
- 2025-12-15: Added visual rain FX: a GPU-instanced streak field around the camera that samples the weather rain channel for intensity and tilts streaks using the local wind vector decoded from the aux weather map; new HUD controls gate/scale the effect.
- 2025-12-15: Volumetric cloud detail is now advected using the simulated wind field (aux map) instead of a constant wind direction, making cloud motion track the pressure-driven circulation patterns.
- 2025-12-15: Atmosphere scattering now samples the weather rain channel to boost near-ground Mie (haze) in rainy regions; added a HUD slider to tune rain haze strength.
- 2025-12-15: Generalized the weather sim to support a configurable number of vertical moisture layers (1–4). The default remains 2 layers (boundary + free troposphere), with evaporation feeding the bottom layer and condensation targeting the first upper layer when available.
- 2025-12-15: Fixed volumetric clouds being hard to see from orbit: when the cloud height slider pushed the layer below the surface clamp, the shell thickness collapsed to a tiny minimum, so top-down rays produced near-zero alpha and got discarded. Cloud shells now keep a stable thickness even when clamped above the surface.
- 2025-12-15: Started v2 “true 3D” weather: added WaterCycleVolumeSystem (N³ voxel atmosphere with ping‑pong neighbor reads/self writes) that outputs a slice-atlas volume texture plus derived 2D weather+aux maps; added separate Water-cycle cloud toggle, 2D/3D sim mode selector, and configurable volume resolution; water-cycle volumetric clouds now sample the 3D atlas by world position (fixes pole artifacts and improves orbit visibility) while legacy/procedural clouds are disabled by default.
- 2025-12-15: v2 stability/realism tweaks: reduced low-resolution “altitude bias” by treating voxels as intersecting the atmosphere shell (using an estimated radial half-extent) so near-surface temps/moisture aren’t sampled from mid-troposphere; updated cloud raymarching to clip to the actual shell segment (stable step size from orbit) and switched to Beer-Lambert style alpha so clouds render correctly from above.
- 2025-12-16: Rolled back keyboard handling in InputRouter (now mobile/VR only), restored direct keyboard listeners inside TinyPlanetControls with merged external+local input, and removed orbit keyboard look hooks. Test: `npm test`.
- 2025-12-16: Fixed TinyPlanet ground movement to respect camera+player orientation (forward now uses combined quaternions projected onto local up) so movement aligns with view direction. Test: `npm test`.
- 2025-12-16: Applied Quake-style smoothing on TinyPlanet ground movement: reduced speeds, added ground friction/stop speed, acceleration, air control, dt clamp, and moved gravity integration to dt for smoother, continuous motion. Test: `npm test`.
- 2025-12-16: Removed green reticle from orbit view (no longer needed for landing indicator). Documented deficiencies and refactor targets in branch.md: incomplete module integration (SceneManager/UIManager/PlanetManager exist but unused), duplicate code across files, missing tests, no centralized state.
- 2025-12-16: HIGH PRIORITY REFACTOR - Created shared modules to consolidate duplicate code:
  - Created utils.js with common utility functions: clamp(), lerp(), normalizeHeightmap(), smoothHeightmap(), isMobileDevice(), nextFrame(), sampleDataTextureRGBA()
  - Created constants.js with magic numbers: BASE_RADIUS_UNITS, DEFAULT_DIAMETER_KM, DEFAULT_RADIUS_M, PERSON_HEIGHT_M, PRESETS, MAX_DELTA_TIME
  - Updated index.js to import from these modules and removed duplicate local definitions for clamp, isMobileDevice, nextFrame
  - PlanetManager.js and UIManager.js updated to import from utils.js and constants.js (local fallbacks still exist but can be removed in future passes)
  - STATUS: COMPLETE - browser verified, app runs without errors
- 2025-12-16: REFACTOR COMPLETED - Removed remaining duplicate function declarations from index.js that were causing SyntaxError "Identifier already declared":
  - Removed duplicate sampleDataTextureRGBA() - now imported from utils.js
  - Removed duplicate normalizeHeightmap() - now imported from utils.js
  - Removed duplicate smoothHeightmap() - now imported from utils.js
  - Browser verified: no more declaration errors, app runs successfully
- 2025-12-16: REFACTOR PASS 2 - Continued consolidation of shared modules across codebase:
  - PlanetManager.js: Removed local normalizeHeightmap()/smoothHeightmap() methods, now uses imports from utils.js; using imported DEFAULT_DIAMETER_KM constant
  - UIManager.js: Removed local clamp() method and BASE_RADIUS_UNITS/DEFAULT_DIAMETER_KM properties, now uses imports
  - WaterCycleUtils.js: Removed local clamp() function, now imports from utils.js (re-exports for backward compat)
  - TinyPlanetControls.js: Now imports BASE_RADIUS_UNITS from constants.js instead of hardcoding 10
  - Browser verified: all changes work correctly, no errors
- 2025-12-16: REFACTOR PASS 3 - Removed duplicate presets object from index.js:
  - index.js: Removed local `presets` object (duplicate of PRESETS in constants.js)
  - index.js: Updated `applyPreset()` to use `PRESETS` from constants.js instead of local `presets`
  - Refactor status: Shared modules (utils.js, constants.js) complete; next step is wiring SceneManager/PlanetManager/UIManager
- 2025-12-16: Refactor (planet wiring): index.js now generates planets through PlanetManager (SceneManager-driven renderer/camera/lights), syncs cloud layers into CloudSystem, updates AtmosphereSystem uniforms each frame, and uses sceneManager.update for rendering instead of manual renderer/controls. Water/atmosphere/cloud creation no longer uses local builders. Test: `npm test`.
- 2025-12-16: Refactor (scene wiring): SceneManager now owns renderer/scene/camera/controls/lights/shadows; index.js now uses the module instead of building its own scene, removed local starfield/light setup, and resize logic now just updates input/mobile visibility. Test: `npm test`.
- 2025-12-16: Atmosphere wiring + mouse fix: AtmosphereSystem now samples weatherMap/rainHaze (for rain haze) with defaults; PlanetManager exposes setAtmosphereWeather and updateAtmosphere accepts weather props; index wires rain-haze slider + weather texture into AtmosphereSystem per-frame and via applyWaterCycleConfig. SceneManager.update can skip control updates; animate calls sceneManager.update(!tinyControls.enabled) to restore mouse/orbit input while Tiny mode runs pointer lock separately. Test: `npm test`.
- 2025-12-16: UI/legacy cleanup: UIManager now owns presets + read/write settings + status/hud update; index.js delegates range labels and regen/preset/diameter callbacks to UIManager. Removed legacy water/atmosphere builders and replace* helpers from index.js; cloud builder stub now delegates to CloudSystem; water/atmo functions deleted. Test: `npm test`.
- 2025-12-16: Bugfix: UIManager.setStatus bound and null-safe; index.js now passes a bound status callback to PlanetManager.generate to avoid undefined `els` crash. Test: `npm test`.
- 2025-12-16: WebGL guard: SceneManager now retries renderer creation with simpler configs and throws a clear WebGL-unavailable error; index.js wraps SceneManager init, reports status if creation fails (e.g., GPU/webgl disabled or XR emulator), instead of crashing mid-boot. Test: `npm test`.
- 2025-12-16: Bugfix: Guarded AtmosphereSystem uniforms in animate (weatherMap/rainHaze/planetInvScale) and hardened setWeather to ensure weatherMap exists, fixing TypeError when syncing weather textures. Test: `npm test`.
- 2025-12-16: Bugfix: Guarded water-cycle cloud uniforms in animate so volume cloud meshes (no windOffset) no longer throw when updating wind/time. Test: `npm test`.
- 2025-12-16: Defaulted the simple cloud layer off (HTML + presets) so volumetric/water-cycle clouds are primary; water-cycle cloud rebuild now requires volume data instead of falling back to the simple procedural layer. Test: `npm test`.
- 2025-12-16: Water-cycle clouds: restored raymarched sampling with resolution-scaled steps in CloudSystem volume shader (denser sampling for high-res atlases, Beer-Lambert accumulation) to match higher-resolution weather visuals. Test: `npm test`.
- 2025-12-16: Fixed shader compile error in CloudSystem volume fragment (moved density sampling into a function and kept a single main). Test: `npm test`.
- 2025-12-16: Volumetric clouds: bumped sun highlight mix back to 0.7→1.4 and added a tiny density floor (0.01 * quantity) to prevent “empty shell” frames when the volume is ultra-sparse. Test: `npm test`.
- 2025-12-16: Ported the inline water-cycle volumetric cloud shader into CloudSystem.buildVolumeCloudMesh (trilinear atlas sampling + procedural FBM detail, rain modulation, shell clipping, planet/volume meta-driven radii). Test: `npm test`.
- 2025-12-16: Lowered water-cycle volume resolution min to 1, defaulted slider to 8, and restored weather slider label updates. Test: `npm test`.
- 2025-12-16: Added a volume-grid weather debug mode that draws cell borders on the volume slice preview. Test: `npm test`.
- 2025-12-16: Added 3D volume grid wireframe overlay in the volumetric cloud shader (debug mode). Test: `npm test`.
- 2025-12-16: Added raymarch step min/max sliders and ray bundling control; plumbed through to the volumetric cloud shader with bundled world rays. Test: `npm test`.
