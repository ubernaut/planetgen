llm instructions for this file: this file is a log of development. It's used to keep track of what has been tried, what issues have come up, what implementation decisions have been made.  an llm should be able to read this file to come up to speed for this project. you should not rewrite this file only append to the end of it.  keep this file concise and not exhaustive.

- 2024-05-27: Added HUD collapse toggle that defaults to collapsed on mobile to clear screen space; no control mapping changes yet.
- 2024-05-27: Added tectonic controls (plate size variance, desymmetry toggle), set default plates to 9, made HUD sections collapsible; Worldgen supports size bias + tiling skew.
- 2024-05-27: Unified collapser styling across HUD sections (default closed), commented out planet diameter slider, and fixed cloud shader timing to use delta/capped jumps to avoid speed spikes after tab inactivity.
- 2024-05-27: Added favicon derived from planet look, renamed input module to InputRouter and wired import.
- 2024-05-27: Swapped to TrackballControls for overview mode; added mobile control overlay (move/run/jump/fly/exit) tied into InputRouter with auto-show on small screens.
- 2024-05-27: Upgraded mobile controls to twin analog pads (move + look), added look deltas and clear on exit/desktop, and disabled pointer lock on mobile to fix exiting first-person.
- 2024-05-27: Moved action buttons between sticks with new Surface action (centers player on visible surface), restored orbit camera state on exiting Tiny mode, and improved InputRouter with surface action + twin-pad look delta.
- 2024-05-27: Mobile overlay now hides when not in Tiny mode; only shows Surface button in overview, with action buttons moved above right stick; surface trigger now forces handler so it executes.
- 2024-05-27: Refined swimming transitions to ignore shallow water, tighten entry/exit thresholds, and realign on exit to avoid tilted posture.
- 2024-05-27: Added center reticle to indicate Surface target; it hides when config panel is open.
- 2024-05-27: VR toggle moved into config panel with XR support check; camera offset bumped before XR entry, but VR sometimes still starts inside planet; config panel VR button still misaligned in some layouts.
- 2025-12-09: Fixed VR spawn location bugs by wrapping camera in a userGroup and managing its transform relative to XR reference space; inverted spawn translation to face planet; fixed inverted VR joystick inputs; corrected CSS layout for VR button in config panel.
- 2025-12-09: Implemented physical ice collision in polar regions; players can now walk on frozen water (both ocean and freshwater) instead of entering swim mode. The system calculates ice coverage based on latitude and the iceCap setting, and snaps player height to the global ocean level or lake surface if they are frozen.
- 2025-12-09: Refactored index.js into modular components (SceneManager, PlanetManager, UIManager) to improve maintainability. Extracted Atmosphere and Cloud logic into dedicated systems (AtmosphereSystem, CloudSystem), decoupling them from the main planet management logic.
- 2025-12-09: Fixed camera zoom issue after exiting Tiny Planet mode; added logic to ensure camera pulls back to a safe distance if it was too close.
- 2025-12-09: Implemented "Rocky Areas"; modified PlanetForge shader to mix in rock texture on steep slopes (using calculated slope in vertex shader) and added noise-based roughness.
- 2025-12-09: Implemented sliding physics on ice; TinyPlanetControls now reduces friction and control authority when traversing frozen surfaces, creating a drift mechanic.
- 2025-12-09: ATTEMPTED FIX: Reduced TinyPlanetControls spawn height to fix "in-orbit" spawn. FAILED: User reported screen freeze.
- 2025-12-09: TERMINATION: Fired for failing to fix first-person entry. ROOT CAUSE IDENTIFIED: The animation loop in index.js skips the render call when TinyPlanetControls is enabled.
- 2025-12-10: Fixed Tiny Planet freeze by always calling SceneManager.update() each frame in index.js (render no longer gated by control mode).
- 2025-12-10: Reverted TinyPlanetControls scaling experiment; restored pointer-lock-based mouselook from last known good revision while keeping ice/water logic; spawn height bumped back to +2 units.
- 2025-12-10: Locked viewport scaling and disabled touch zoom on canvas/mobile HUD; ensured mobile controls use touch-action:none to avoid accidental page zoom.
- 2025-12-10: Kept planet/render loop running in Tiny mode by ticking PlanetManager every frame (rotation pauses only in Tiny); water/cloud/atmosphere animation and rendering now continue in first-person.
- 2025-12-10: Restored orbit camera parent on Tiny exit, blocked Trackball touch events to avoid undefined pointer errors, and aligned Tiny spawn yaw/pitch to previous orbit forward so you don't start aimed at the ground.
- 2025-12-10: Force Tiny spawn height from forge heightmap (plus player height), normalize saved forward, and update matrices before snapping; guarded Trackball touch overrides to avoid undefined-bind crashes.
- 2025-12-10: Added Tiny spawn debug dump (pointer lock, player world pose, forward, sampled height, input state) to diagnose remaining first-person spawn/mouselook issues.
- 2025-12-10: Added pointer-lock retry/focus on Tiny enter, snap debug logging, and canvas tabindex for focus to diagnose missing mouselook input; snap now logs final pose and ray hit.
- 2025-12-10: Replaced snap raycast with direct heightmap snap to planet surface (uses forge height), and reset mouse fallback when pointer lock releases to stabilize mouselook.
- 2025-12-10: Simplified Tiny orientation: build tangent basis purely from surface normal (no saved orbit forward) so initial look is always along the horizon, not toward the center.
- 2025-12-10: FAILURE: Despite multiple iterations (pointer-lock retries, tangent-only orientation, heightmap snaps, debug logs), TinyPlanet first-person remains broken: spawn still lands underground/looking inward for the user, mouselook fails without lock, and orientation remains wrong. Keys are seen but camera placement/orientation and lock behavior are unresolved.
- 2025-12-10: ROOT CAUSE FOUND: Duplicate `onPointerLockChange` method in TinyPlanetControls.js. The second definition was silently overwriting the first, preventing proper pointer lock state tracking and `prevMouse` reset. Removed duplicate method definition.
- 2025-12-13: FIXED: Cloud shader progressive acceleration bug. Root cause: The shader used `windDir * time` where windDir rotates over time (windAngle = time * 0.2) AND was multiplied by time again, causing velocity = d(windDir*time)/dt to grow linearly with time (acceleration). Fix: Introduced separate `windOffset` uniform that accumulates at constant rate controlled by speed slider; wind direction is now constant (set at creation) to prevent spiral pattern acceleration. Tab inactivity fix (delta capping at 0.25s) remains in place.
- 2025-12-14: Implemented v0 WebGPU water cycle + weather system: a compute-simulated lat/lon field (temperature, vapor, cloud water, rain, pressure anomaly, wind, soil wetness) with ocean evaporation (sunlit), condensation (qsat + lift cooling), precipitation + deposition, and geostrophic-style winds from pressure gradients. Outputs an RGBA weather texture via double-buffered readback, drives new volumetric cloud raymarch shader, and darkens land via wetness sampling in the planet shader.
- 2025-12-14: Replaced the atmosphere “rim glow” shader with a physically-inspired single-scattering approximation (Rayleigh + Mie, height falloff, sun occlusion) that looks correct both from orbit and when standing on the surface (sky gradient + bright horizon).
- 2025-12-14: Fixed volumetric clouds disappearing: atmosphere was drawing after clouds with additive blending while clouds don’t write depth, washing them out. Set atmosphere renderOrder to draw before clouds instead.
- 2025-12-15: Set atmosphere alpha default to 1.0 (UI + presets) and increased scattering density (added a `density` uniform, default 6.0) to make the daytime sky feel fuller.
- 2025-12-15: Added a Water Cycle HUD section (enable toggle, sim speed, readback Hz, evap/precip/wind multipliers, wetness strength) wired into WaterCycleSystem + terrain wetness; set the legacy/simple cloud layer toggle off by default.
- 2025-12-15: Fixed “no clouds” regression by re-enabling the volumetric cloud layer toggle by default (cloud meshes were never created when unchecked).
- 2025-12-15: Iterated the weather sim: added two-layer humidity (boundary layer + free troposphere) with mixing + ascent/subsidence exchange, added snow/rain phase split (cold precip doesn’t count as rain/wetness), added ocean thermal inertia for slower ocean temperature response, added forced step+readback and a terrain debug view (cloud/rain/pressure/soil) via a new `uWeatherDebug` uniform.
- 2025-12-15: Fixed weather debug view shader flow: removed an early `return` from the terrain shader injection so the standard Three.js fragment output path still runs when debug mode is enabled.
- 2025-12-15: Added a second “aux” weather texture output from the WebGPU sim (RGBA: temp, snowpack, windU, windV) alongside the main weather map (RGBA: cloud, rain, pressure, soil) to avoid brittle bitpacking and enable richer debug/visuals.
- 2025-12-15: Implemented snowpack accumulation from frozen precipitation + temperature/insolation-driven melt feeding soil wetness; terrain shading now incorporates snowpack for dynamic snow cover and the weather debug view now supports temp/snowpack/wind overlays.
- 2025-12-15: Added visual rain FX: a GPU-instanced streak field around the camera that samples the weather rain channel for intensity and tilts streaks using the local wind vector decoded from the aux weather map; new HUD controls gate/scale the effect.
- 2025-12-15: Volumetric cloud detail is now advected using the simulated wind field (aux map) instead of a constant wind direction, making cloud motion track the pressure-driven circulation patterns.
- 2025-12-15: Atmosphere scattering now samples the weather rain channel to boost near-ground Mie (haze) in rainy regions; added a HUD slider to tune rain haze strength.
- 2025-12-15: Generalized the weather sim to support a configurable number of vertical moisture layers (1–4). The default remains 2 layers (boundary + free troposphere), with evaporation feeding the bottom layer and condensation targeting the first upper layer when available.
- 2025-12-15: Fixed volumetric clouds being hard to see from orbit: when the cloud height slider pushed the layer below the surface clamp, the shell thickness collapsed to a tiny minimum, so top-down rays produced near-zero alpha and got discarded. Cloud shells now keep a stable thickness even when clamped above the surface.
- 2025-12-15: Started v2 “true 3D” weather: added WaterCycleVolumeSystem (N³ voxel atmosphere with ping‑pong neighbor reads/self writes) that outputs a slice-atlas volume texture plus derived 2D weather+aux maps; added separate Water-cycle cloud toggle, 2D/3D sim mode selector, and configurable volume resolution; water-cycle volumetric clouds now sample the 3D atlas by world position (fixes pole artifacts and improves orbit visibility) while legacy/procedural clouds are disabled by default.
- 2025-12-15: v2 stability/realism tweaks: reduced low-resolution “altitude bias” by treating voxels as intersecting the atmosphere shell (using an estimated radial half-extent) so near-surface temps/moisture aren’t sampled from mid-troposphere; updated cloud raymarching to clip to the actual shell segment (stable step size from orbit) and switched to Beer-Lambert style alpha so clouds render correctly from above.
- 2025-12-16: Rolled back keyboard handling in InputRouter (now mobile/VR only), restored direct keyboard listeners inside TinyPlanetControls with merged external+local input, and removed orbit keyboard look hooks. Test: `npm test`.
- 2025-12-16: Fixed TinyPlanet ground movement to respect camera+player orientation (forward now uses combined quaternions projected onto local up) so movement aligns with view direction. Test: `npm test`.
- 2025-12-16: Applied Quake-style smoothing on TinyPlanet ground movement: reduced speeds, added ground friction/stop speed, acceleration, air control, dt clamp, and moved gravity integration to dt for smoother, continuous motion. Test: `npm test`.
